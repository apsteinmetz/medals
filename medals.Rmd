---
title: "Medals"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(rvest)
```

I chose to get the medal total by scraping the NBC site.  Doubtless you could find another source for this.  Making an error proof run through the countries was like navigating slalom gates.  The code is simple now but, due to variations in the tables from country to country it took a  number of iterations to get this right.  By the time you see this the web site may have changed or disappeared.

```{r}
#get top medal countries. Countries with 10 or more medals in total
URL_stub<-"http://www.nbcolympics.com/medals/"
countries<-as_factor(c("Norway","Germany","Netherlands","Austria","Switzerland",
             "France","Sweden","Italy","olympic-athlete-russia",
             "south-korea","Japan",
             "united-states","Canada"))

regions=as_factor(c(rep("Europe",9),rep("Asia",2),rep("America",2)))
regions<-bind_cols(Country=countries,region=regions)

#country<-"Canada"
all_medals<-data_frame()
for (country in countries){
print(country)
medals_raw<-read_html(paste0(URL_stub,country))
medals<-medals_raw %>% 
  html_node(xpath="//table[@class='grid-table grid-table-2018']") %>% 
  html_table() %>% .[,1:5] %>% 
  mutate(Country=country) %>% 
  # get rid of special chars
  mutate(Sport=str_extract(Sport,"(\\w|\\-| )+")) %>%
  select(Country,everything()) %>%
  {.}
all_medals<-bind_rows(medals,all_medals)
}
save(all_medals,file="all_medals.rdata")

```
Now get the Wikipedia page that describes the first year an event was held.  Again, there is no guarantee that the page format won't change in the future.
```{r}
URL<-"https://en.wikipedia.org/wiki/Winter_Olympic_Games"
wiki_page_raw<-read_html(URL)

current_sports<-wiki_page_raw %>% 
  html_node(xpath="//*[@id='mw-content-text']/div/table[3]") %>% 
  html_table() %>% .[,1:4] %>% 
  mutate(Years=str_extract(Years,"\\d{4}")) %>% 
  rename(Notes=`Medal events contested in 2014`,Year=Years) %>% 
  mutate(Notes=str_replace(Notes,"\\[\\d+\\]",""))

save(current_sports,file="current_sports.rdata")


```

Now align the names of the sports in both tables. 
```{r}
#we can get some better alignment by forcing case agreement
all_medals<-all_medals %>% mutate(Sport=str_to_title(Sport))
current_sports<-current_sports %>% mutate(Sport=str_to_title(Sport))

#manually fix the four remaining problems
current_sports<-current_sports %>% mutate(Sport=ifelse(Sport=="Short Track Speed Skating","Short Track",Sport))
current_sports<-current_sports %>% mutate(Sport=ifelse(Sport=="Bobsleigh","Bobsled",Sport))
current_sports<-current_sports %>% mutate(Sport=ifelse(Sport=="Ice Hockey","Hockey",Sport))
current_sports<-current_sports %>% mutate(Sport=ifelse(Sport=="Cross-Country Skiing","Cross-Country",Sport))


all_medals %>% select(Sport) %>% distinct() %>% left_join(current_sports)

```

Good!  It must be noted that we are working with tiny data here. If my boss asked me to do this I would just manually create all these tables.  Here at OutsideRdata we do things, not the hard way, but the way that teaches us the most!

The cleaning is done.  Now lets join the tables and add some features that will add some context.  

```{r}
final_table <- all_medals %>% 
  select(Country,Sport,Total) %>% 
  left_join(current_sports) %>% .[,1:4] %>% 
  left_join(regions) %>%
  group_by(region,Country)

final_table$Country <- as_factor(final_table$Country,levels=levels(countries))




final_table %>% ggplot(aes(Year,Country,fill=Total))+geom_tile()
```
